SERIAL NUMBER NEEDS TO BE CHANGE MANUALLY FOR BELOW QUERY

TRUNCATE TABLE TDCC_PTN_TEMP;

INSERT INTO TDCC_PTN_TEMP
SELECT 
REPLACE (TRIM(M.MASTER_REF),'/','-') B2K_ID,
REPLACE (TRIM(M.MASTER_REF),'/','-') B2KID_TYPE,
'A' EVENT_TYPE,
'1' EVENT_SRL_NUM,
'1' TFCT_SRL_NUM,
'1' TDCC_KEY_SRL_NUM,
'Y' ENTITY_CRE_FLG,
FRQ.EXPIRY_DAT DUE_DATE,
'C' CR_DR_IND,
FRQ.CCY TRAN_CRNCY_CODE,
TO_CHAR(FRQ.NEW_AMOUNT/C8.C8PWD,'99999999999999.99') TRAN_AMT,
'' TRAN_ID,
FRQ.NEW_START_DATE TRAN_DATE,
'PENDED' TRAN_RMKS,
'' STATUS_FLG,
'' PTRAN_BUS_TYPE,
'N' DEL_FLG,
'SYSTEM' LCHG_USER_ID,
SYSDATE LCHG_TIME,
'SYSTEM' RCRE_USER_ID,
SYSDATE RCRE_TIME,
'0' TS_CNT,
'01' BANK_ID,
FRQ.NEW_FREQ FREQUENCY
FROM MASTER_ODS M
INNER join (
SELECT DISTINCT 
MA.MASTER_REF,CASE WHEN TS.P_CHG_UNIT='D' THEN BE.AMOUNT/TS.P_CHG_NO*30 ELSE BE.AMOUNT END NEW_AMOUNT,
ADD_MONTHS (BE.START_DATE,CASE WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=3 THEN 3
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=6 THEN 6
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=12 THEN 12
     WHEN TS.P_CHG_UNIT='Q' THEN 3
     WHEN TS.P_CHG_UNIT='H' THEN 6
     WHEN TS.P_CHG_UNIT IN ('Y','A') THEN 12
     ELSE 1 END) NEW_START_DATE,
TS.P_CHG_UNIT,BE.CCY,MA.EXPIRY_DAT,TS.P_CHG_NO,
CASE WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=3 THEN 'Q'
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=6 THEN 'H'
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=12 THEN 'Y'
     WHEN TS.P_CHG_UNIT='D' THEN 'M'
     ELSE TS.P_CHG_UNIT END NEW_FREQ
FROM MASTER_ODS MA
LEFT JOIN BASEEVENT_ODS BE ON MA.KEY97=BE.MASTER_KEY AND BE.TYPEFLAG='30881'
INNER JOIN PAYCHARGES_ODS PO ON PO.KEY97=BE.KEY97 
LEFT JOIN TIDATAITEM_ODS TI ON TI.KEY97=MA.PCP_PTY AND TI.TYPEFLAG='27713'
LEFT JOIN PARTYDTLS_ODS PA ON PA.KEY97=TI.KEY97
LEFT JOIN GFPF_ODS GF ON REPLACE(TRIM(PA.CUS_MNM),' ','')=REPLACE(TRIM(GF.GFCUS1),' ','')
INNER JOIN TF_RISKPART_MASTER TF ON TF.MASTER_REF=MA.MASTER_REF
LEFT JOIN DIARYENTRY_ODS DE ON MA.KEY97=DE.MASTER_KEY AND DE.TYPEFLAG ='31115'
LEFT JOIN RELITEM_ODS RI ON BE.KEY97=RI.EVENT_KEY AND RI.TYPEFLAG='20678'
LEFT JOIN PERIODCHG_ODS PC ON PC.KEY97=RI.KEY97
LEFT JOIN BASECHARGE_ODS BC ON BC.KEY97=RI.KEY97
LEFT JOIN EVENTCHG_ODS EC ON EC.KEY97=BC.KEY97
LEFT JOIN CHARGE99_ODS C99 ON C99.KEY97=EC.CHG_SCH
LEFT JOIN CHARGE04_ODS C04 ON C04.KEY97=C99.CHG_TYPE
LEFT JOIN TRANSCHED_ODS TS ON TS.KEY97=EC.TCHG_SCH
WHERE MA.REFNO_PFIX='PTN' AND BE.REFNO_PFIX='PCH'  AND BE.STATUS NOT IN ('c','a') AND DE.KEY97 IS NULL AND BE.AMOUNT!=0
AND 
ADD_MONTHS (BE.START_DATE,CASE WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=3 THEN 3
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=6 THEN 6
     WHEN TS.P_CHG_UNIT='M' AND TS.P_CHG_NO=12 THEN 12
     WHEN TS.P_CHG_UNIT='Q' THEN 3
     WHEN TS.P_CHG_UNIT='H' THEN 6
     WHEN TS.P_CHG_UNIT IN ('Y','A') THEN 12
     ELSE 1 END)<MA.EXPIRY_DAT
) FRQ on FRQ.MASTER_REF = M.MASTER_REF 
LEFT JOIN C8PF C8 ON C8.C8CCY=FRQ.CCY
WHERE M.REFNO_PFIX = 'PTN'; 

COMMIT;

UPDATE TDCC_PTN_TEMP A SET TFCT_SRL_NUM =(SELECT RANK1 FROM(
SELECT B2K_ID,ROWID ROW_ID,DENSE_RANK() OVER (PARTITION BY B2K_ID ORDER BY ROWID) RANK1 FROM TDCC_PTN_TEMP ) B WHERE A.ROWID = B.ROWID);

COMMIT;

TRUNCATE TABLE TFCT_PTN_TEMP;

COMMIT;

INSERT INTO TFCT_PTN_TEMP
SELECT
B2K_ID,
B2KID_TYPE,
T.EVENT_TYPE,
EVENT_SRL_NUM,
TFCT_SRL_NUM,
T.ENTITY_CRE_FLG,
'N' DEL_FLG,
T.PTRAN_BUS_TYPE,
B.EVENT_ID CHRG_EVENT_ID,--TRIM(T1.BG_TYPE) ||'_CHGS' CHRG_EVENT_ID,
'' CHRG_EVENT_TYPE,
'' CHRG_COLL_TYPE,
CR_DR_IND,
TRAN_CRNCY_CODE,
'' CHRG_PART_TRAN_SRL_NUM,
TRAN_AMT TTL_SYS_CALC_CHRG_AMT,
TRAN_AMT TTL_CHRG_TOBE_COLL_AMT,
TRAN_AMT TTL_CHRG_DUE_AMT,
'' TTL_CHRG_COLL_AMT,
TRIM(T1.BG_OPERATIVE_ACCOUNT_ID) OPER_ACID, -- TO BE CORRECTED
TRIM(T1.BG_CURRENCY) OPER_CRNCY_CODE, -- TO BE CORRECTED
--TRIM(T1.BG_OPERATIVE_ACCOUNT_ID) CHRG_ACID, -- TO BE CORRECTED
'900'||CRNCY_ALIAS_NUM||P.BACID CHRG_ACID,
'MID' RATE_CODE,
'1' RATE,
'' CONV_RATE_CODE,
'' CONV_RATE,
'A' PAYABLE_BY,
'N' WAIVE_FLG,
'' WAIVER_AMT,
'' WAIVE_REMARKS,
'' REMARKS_CHARGES,
'' DR_CONS_FLG,
'' MODIFY_FLG,
'' AMT_WITHOUT_DISCOUNT,
'' CHRG_RPT_CODE,
'' DEBIT_CHARGE_RCVBLE_ACCT_FLG,
TRAN_AMT TTL_CHRG_RECEIVABLE_AMT,
'' DEBIT_CHARGE_RECEIVABLE_ACID,
'' ENTITY_STATUS,
'' TRAN_PARTICULAR,
'' TRAN_PARTICULAR_CODE,
'' MOD_SCH_FLG,
'' CHRG_SH_PCNT,
'' CHRG_SPLIT_PCNT,
'' CHRG_SPLIT_AMT,
FREQUENCY CHRG_SPLIT_IND,
'' PARENT_TFCT_SRL_NUM,
'' LATER_COLL_DATE,
TRAN_DATE START_DATE,
DUE_DATE END_DATE,
FREQUENCY DEF_CHRG_FREQ_TYPE,
'' DEF_CHRG_FREQ_WEEK_NUM,
'' DEF_CHRG_FREQ_WEEK_DAY,
TO_CHAR(DUE_DATE,'DD') DEF_CHRG_FREQ_START_DD,
'N' DEF_CHRG_HLDY_STAT,
'Y' AMORT_FLG,
'' REMIT_THROUGH_MSG_SYS,
'' POBC_TRAN_ID,
'' POBC_TRAN_DATE,
'N' REFUND_FLG,
'900' SOLID, --SUBSTR(B2K_ID,1,3) SOL_ID,
'' VERFN_PENDING_FROM,
'' CUST_ID,
'01' BANK_ID,
'SYSTEM' LCHG_USER_ID,
SYSDATE LCHG_TIME,
'SYSTEM' RCRE_USER_ID,
SYSDATE RCRE_TIME,
'' TS_CNT,
'F' AMT_IND,
'' TREASURY_RATE,
'' TREASURY_REF_NUM,
TRAN_AMT TTL_SYS_CALC_CHRG_GENE_AMT
FROM TDCC_PTN_TEMP T
INNER JOIN TF001_RISK T1 ON TRIM(T1.BG_NUM)=TRIM(B2K_ID) AND T1.FUNC_CODE='A'
LEFT JOIN TBAADM.BGP B ON B.BG_TYPE=TRIM(T1.BG_TYPE) AND B.BANK_ID='01'
LEFT JOIN TBAADM.PTT P ON P.BANK_ID='01' AND P.EVENT_ID=B.EVENT_ID AND P.EVENT_TYPE='BGADD' AND P.PTRAN_BUS_TYPE='COMM'
LEFT JOIN TBAADM.CNC C ON C.CRNCY_CODE=T.TRAN_CRNCY_CODE AND C.BANK_ID='01';

COMMIT;

truncate table tdcc_final_PTN_TEMP;



DECLARE

frq number;
total_charge number;
frq_in_months number;
last_ins_date date;
CURSOR c1
is
select * from tdcc_PTN_TEMP;

 BEGIN

FOR l_record IN c1
LOOP   

    
   IF l_record.FREQUENCY='M' THEN
      frq_in_months := 1;
   ELSIF  l_record.FREQUENCY='Q' THEN
      frq_in_months := 3;
   ELSIF  l_record.FREQUENCY='H' THEN
      frq_in_months := 6;
   ELSIF  l_record.FREQUENCY='Y' THEN
      frq_in_months := 12;
   else 
       frq_in_months := 1;
   END if;
    
    total_charge := 0;
    frq := 0;
    last_ins_date := l_record.TRAN_DATE;
    
    while l_record.due_date > last_ins_date 
    loop  
    
    if TO_DATE(get_param('EOD_DATE'),'DD-MM-YYYY') > last_ins_date then
    last_ins_date := ADD_MONTHS(last_ins_date,frq_in_months);
       
       if(to_char(last_ins_date,'dd') != to_char(l_record.TRAN_DATE,'dd') and (to_char(last_ins_date,'dd') <10)) then
        last_ins_date := last_day(ADD_MONTHS(last_ins_date,-1));
       end if;
    continue;
    end if;    
    
       insert into tdcc_final_PTN_TEMP select 
       l_record.B2K_ID,
       l_record.B2KID_TYPE,
       l_record.EVENT_TYPE,
       l_record.EVENT_SRL_NUM,
       l_record.TFCT_SRL_NUM,
       frq+1,
       l_record.ENTITY_CRE_FLG,
       last_ins_date,
       l_record.CR_DR_IND,
       l_record.TRAN_CRNCY_CODE,
       l_record.TRAN_AMT,
       l_record.TRAN_ID,
       last_ins_date,
       l_record.TRAN_RMKS,
       l_record.STATUS_FLG,
       l_record.PTRAN_BUS_TYPE,
       l_record.DEL_FLG,
       l_record.LCHG_USER_ID,
       l_record.LCHG_TIME,
       l_record.RCRE_USER_ID,
       l_record.RCRE_TIME,
       l_record.TS_CNT,
       l_record.BANK_ID
       from dual;
       commit;
       frq := frq+1;
       last_ins_date := ADD_MONTHS(last_ins_date,frq_in_months);
      
       if(to_char(last_ins_date,'dd') != to_char(l_record.TRAN_DATE,'dd') and (to_char(last_ins_date,'dd') <10)) then
        last_ins_date := last_day(ADD_MONTHS(last_ins_date,-1));
       end if;
       
       total_charge := total_charge + l_record.TRAN_AMT;
      end loop;  
      
       insert into tdcc_final_PTN_TEMP select 
       l_record.B2K_ID,
       l_record.B2KID_TYPE,
       l_record.EVENT_TYPE,
       l_record.EVENT_SRL_NUM,
       l_record.TFCT_SRL_NUM,
       frq+1,
       l_record.ENTITY_CRE_FLG,
       l_record.due_date,
       l_record.CR_DR_IND,
       l_record.TRAN_CRNCY_CODE,
       l_record.TRAN_AMT,
       l_record.TRAN_ID,
       l_record.due_date,
       l_record.TRAN_RMKS,
       l_record.STATUS_FLG,
       l_record.PTRAN_BUS_TYPE,
       l_record.DEL_FLG,
       l_record.LCHG_USER_ID,
       l_record.LCHG_TIME,
       l_record.RCRE_USER_ID,
       l_record.RCRE_TIME,
       l_record.TS_CNT,
       l_record.BANK_ID
       from dual;
       
       commit;
    total_charge := total_charge+l_record.TRAN_AMT;
      
      UPDATE TFCT_PTN_TEMP t2 SET TTL_SYS_CALC_CHRG_AMT = total_charge , TTL_CHRG_TOBE_COLL_AMT = total_charge,
       TTL_CHRG_DUE_AMT=total_charge, TTL_CHRG_RECEIVABLE_AMT=total_charge, TTL_SYS_CALC_CHRG_GENE_AMT=total_charge,END_DATE=l_record.due_date WHERE TRIM(t2.B2K_ID)=trim(l_record.B2K_ID) 
       and TRIM(t2.TFCT_KEY_SRL_NUM) = trim(l_record.TFCT_SRL_NUM) ;    
       
    commit;  
    
    
end loop;
commit;
end;

COMMIT;

/

insert into tdcc_final_PTN_TEMP  
select B2K_ID, B2KID_TYPE, EVENT_TYPE, EVENT_SRL_NUM, TFCT_SRL_NUM, TDCC_KEY_SRL_NUM, ENTITY_CRE_FLG, DUE_DATE, CR_DR_IND, TRAN_CRNCY_CODE, 
TRAN_AMT, TRAN_ID, TRAN_DATE, TRAN_RMKS, STATUS_FLG, PTRAN_BUS_TYPE, DEL_FLG, LCHG_USER_ID, LCHG_TIME, RCRE_USER_ID, RCRE_TIME, TS_CNT, BANK_ID 
from tdcc_PTN_TEMP where DUE_DATE<to_date(get_param('EOD_DATE'),'DD-MM-YYYY');

COMMIT;


SELECT B2K_ID,TFCT_SRL_NUM,SUM(TRAN_AMT) FROM tdcc_final_PTN_TEMP GROUP BY B2K_ID,TFCT_SRL_NUM


SELECT * FROM TFCT_PTN_TEMP WHERE B2K_ID='PTN13-900-001061'



SELECT DISTINCT B2K_ID,MAX(TFCT_KEY_SRL_NUM) FROM TFCT_PTN 
WHERE B2K_ID IN (SELECT B2K_ID FROM TFCT_PTN_TEMP)
GROUP BY B2K_ID

EDIT TDCC_FINAL_PTN_TEMP WHERE B2K_ID='PTN16-900-001508' ORDER BY B2K_ID,TO_NUMBER(TFCT_SRL_NUM) 


SELECT B2K_ID,TFCT_SRL_NUM,SUM(TRAN_AMT) FROM TDCC_FINAL_PTN_TEMP GROUP BY B2K_ID,TFCT_SRL_NUM

SELECT B2K_ID,TFCT_KEY_SRL_NUM,TTL_SYS_CALC_CHRG_AMT FROM TFCT_PTN_TEMP 

EDIT TFCT_PTN_TEMP WHERE B2K_ID='PTN17-900-001590'