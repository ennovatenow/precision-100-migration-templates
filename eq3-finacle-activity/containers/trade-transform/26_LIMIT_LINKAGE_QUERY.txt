DROP TABLE TF_LIMIT_LINKAGE;

CREATE TABLE TF_LIMIT_LINKAGE AS
SELECT BG_NUM REF_NO,TO_CHAR(CIF_ID) CUSTOMER,BG_TYPE TYPE,BG_CLASS CLASS,
CASE WHEN TRIM(BG_TYPE)='LGFN' THEN 'GELGF'
     WHEN TRIM(BG_TYPE)='LGAP' THEN 'GELGA'
     WHEN TRIM(BG_TYPE)='LGPU' THEN 'GELGU'
     WHEN TRIM(BG_TYPE)='LGBD' THEN 'GELGI'
     WHEN TRIM(BG_TYPE)='LGPR' THEN 'GELGP'
     WHEN TRIM(BG_TYPE)='LGRT' THEN 'GELGR'
     WHEN TRIM(BG_TYPE)='LGPH' THEN 'GELGO'
     WHEN TRIM(BG_TYPE)='LGOT' THEN 'GELGO'
     WHEN TRIM(BG_TYPE)='LGML' THEN 'GELGL'
     WHEN TRIM(BG_TYPE)='LGSH' THEN 'GELGS'
     ELSE '' END LEVEL_7,
LIMIT_PREFIX,LIMIT_SUFFIX
FROM TF001 TF 
LEFT JOIN LIMIT_CORE_O_TABLE LM ON TRIM(LIMIT_PREFIX)=TRIM(CIF_ID) AND LIMIT_SUFFIX=CASE WHEN TRIM(BG_TYPE)='LGFN' THEN 'GELGF'
     WHEN TRIM(BG_TYPE)='LGAP' THEN 'GELGA'
     WHEN TRIM(BG_TYPE)='LGPU' THEN 'GELGU'
     WHEN TRIM(BG_TYPE)='LGBD' THEN 'GELGI'
     WHEN TRIM(BG_TYPE)='LGPR' THEN 'GELGP'
     WHEN TRIM(BG_TYPE)='LGRT' THEN 'GELGR'
     WHEN TRIM(BG_TYPE)='LGPH' THEN 'GELGO'
     WHEN TRIM(BG_TYPE)='LGOT' THEN 'GELGO'
     WHEN TRIM(BG_TYPE)='LGML' THEN 'GELGL'
     WHEN TRIM(BG_TYPE)='LGSH' THEN 'GELGS'
     ELSE '' END
WHERE  FUNC_CODE='A'
UNION
SELECT BG_NUM,TO_CHAR(CIF_ID),BG_TYPE,BG_CLASS,
CASE WHEN TRIM(BG_TYPE)='RPLG' THEN 'RPBLG'
     WHEN TRIM(BG_TYPE)='RPLC' THEN 'RPBLC'
     ELSE '' END LEVEL_7,
LIMIT_PREFIX,LIMIT_SUFFIX
FROM TF001_RISK 
LEFT JOIN LIMIT_CORE_O_TABLE LM ON TRIM(LIMIT_PREFIX)=TRIM(CIF_ID) AND LIMIT_SUFFIX=CASE WHEN TRIM(BG_TYPE)='RPLG' THEN 'RPBLG'
     WHEN TRIM(BG_TYPE)='RPLC' THEN 'RPBLC'
     ELSE '' END
WHERE FUNC_CODE='A'
UNION
SELECT DC_NUM,TO_CHAR(DC_CIF_ID),DC_TYPE,DC_TENOR,
CASE WHEN TRIM(DC_TYPE)='ILCF' AND DC_TENOR='U' THEN 'GELCU'
     WHEN TRIM(DC_TYPE)='ILCF' AND DC_TENOR='S' THEN 'GELCS'
     WHEN TRIM(DC_TYPE)='ILCL' THEN 'GELCL'
     ELSE 'GESBL' END LEVEL_7,
LM.LIMIT_PREFIX,LM.LIMIT_SUFFIX
FROM TF004 
LEFT JOIN LIMIT_CORE_O_TABLE LM ON TRIM(LM.LIMIT_PREFIX)=TRIM(DC_CIF_ID) AND LM.LIMIT_SUFFIX=CASE WHEN TRIM(DC_TYPE)='ILCF' AND DC_TENOR='U' THEN 'GELCU'
     WHEN TRIM(DC_TYPE)='ILCF' AND DC_TENOR='S' THEN 'GELCS'
     WHEN TRIM(DC_TYPE)='ILCL' THEN 'GELCL'
     ELSE 'GESBL' END 
WHERE FUNC_CODE='S'
UNION
SELECT BG_NUM REF_NO,FIN_CIF_ID CUSTOMER,BG_TYPE TYPE,BG_CLASS CLASS,'GELGC' LEVEL_7, LIMIT_PREFIX,LIMIT_SUFFIX
FROM TF002 TF 
LEFT JOIN MASTER_ODS MA ON REPLACE(MA.MASTER_REF,'/','-')=TRIM(TF.BG_NUM)
LEFT JOIN IGMASTER_ODS IG ON IG.KEY97=MA.KEY97
LEFT JOIN PARTYDTLS_ODS PA ON PA.KEY97=IG.CGTEPRIPTY
LEFT JOIN MAP_CIF MC ON GFCUS||GFCLC=TRIM(REPLACE(CUS_MNM,' ',''))
LEFT JOIN LIMIT_CORE_O_TABLE LM ON TRIM(LIMIT_PREFIX)=TRIM(FIN_CIF_ID) AND LIMIT_SUFFIX='GELGC'
WHERE  FUNC_CODE='A' AND TRIM(BG_TYPE)='ILGC'
UNION
SELECT TRIM(DC_NUM) REF_NO,FIN_CIF_ID CUSTOMER,DC_TYPE TYPE,DC_TENOR CLASS,'GELCC' LEVEL_7, LM.LIMIT_PREFIX,LM.LIMIT_SUFFIX
FROM TF005 T5 
LEFT JOIN MASTER_ODS MA ON REPLACE(MA.MASTER_REF,'/','-')=TRIM(DC_NUM)
LEFT JOIN PARTYDTLS_ODS PA ON PA.KEY97=MA.PCP_PTY
LEFT JOIN MAP_CIF MC ON GFCUS||GFCLC=TRIM(REPLACE(CUS_MNM,' ','')) 
LEFT JOIN LIMIT_CORE_O_TABLE LM ON TRIM(LM.LIMIT_PREFIX)=TRIM(FIN_CIF_ID) AND LM.LIMIT_SUFFIX='GELCC'
WHERE T5.DC_CONFIRMATION_INSTRUCTIONS='Y' AND T5.FUNC_CODE='E';

COMMIT;

UPDATE TF001 SET (LIMITPREFIX,LIMITSUFFIX)= (SELECT LIMIT_PREFIX,LIMIT_SUFFIX FROM TF_LIMIT_LINKAGE WHERE TRIM(REF_NO)=TRIM(BG_NUM));

COMMIT;

UPDATE TF001 SET LIMITPREFIX=rpad(NVL(LIMITPREFIX,' '),12,' '),LIMITSUFFIX=rpad(NVL(LIMITSUFFIX,' '),12,' ');

COMMIT;

UPDATE TF004 T4 SET (T4.LIMITPREFIX,T4.LIMIT_SUFFIX)= (SELECT LL.LIMIT_PREFIX,LL.LIMIT_SUFFIX FROM TF_LIMIT_LINKAGE LL WHERE TRIM(LL.REF_NO)=TRIM(T4.DC_NUM));

COMMIT;

UPDATE TF004 SET LIMITPREFIX=rpad(NVL(LIMITPREFIX,' '),12,' '),LIMIT_SUFFIX=rpad(NVL(LIMIT_SUFFIX,' '),5,' ') ;

COMMIT;

UPDATE TF001_RISK SET (LIMITPREFIX,LIMITSUFFIX)= (SELECT LIMIT_PREFIX,LIMIT_SUFFIX FROM TF_LIMIT_LINKAGE WHERE TRIM(REF_NO)=TRIM(BG_NUM));

COMMIT;

UPDATE TF001_RISK SET LIMITPREFIX=rpad(NVL(LIMITPREFIX,' '),12,' '),LIMITSUFFIX=rpad(NVL(LIMITSUFFIX,' '),12,' ');

COMMIT;

UPDATE TF001 SET LIMITPREFIX='DUMMY       ',LIMITSUFFIX='DUMBG       ' WHERE TRIM(LIMITPREFIX) IS NULL;

UPDATE TF001_RISK SET LIMITPREFIX='DUMMY       ',LIMITSUFFIX='DUMBG       ' WHERE TRIM(LIMITPREFIX) IS NULL;

UPDATE TF004 SET LIMITPREFIX='DUMMY       ',LIMIT_SUFFIX='DUMLC' WHERE TRIM(LIMITPREFIX) IS NULL;

COMMIT;

UPDATE TF002 SET (LIMITPREFIX,LIMITSUFFIX)= (SELECT LIMIT_PREFIX,LIMIT_SUFFIX FROM TF_LIMIT_LINKAGE WHERE TRIM(REF_NO)=TRIM(BG_NUM)) WHERE TRIM(BG_TYPE)='ILGC';

COMMIT;

UPDATE TF002 SET LIMITPREFIX=rpad(NVL(LIMITPREFIX,' '),12,' '),LIMITSUFFIX=rpad(NVL(LIMITSUFFIX,' '),12,' ');

COMMIT;

UPDATE TF005 T5 SET (T5.LIMITPREFIX,T5.LIMIT_SUFFIX)= (SELECT LL.LIMIT_PREFIX,LL.LIMIT_SUFFIX FROM TF_LIMIT_LINKAGE LL WHERE TRIM(LL.REF_NO)=TRIM(T5.DC_NUM)) WHERE DC_CONFIRMATION_INSTRUCTIONS='Y';

COMMIT;

UPDATE TF005 SET LIMITPREFIX=rpad(NVL(LIMITPREFIX,' '),12,' '),LIMIT_SUFFIX=rpad(NVL(LIMIT_SUFFIX,' '),5,' ');

COMMIT;

