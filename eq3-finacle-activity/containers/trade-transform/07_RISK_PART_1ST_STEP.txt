DROP TABLE TF_RISKPART_MASTER;

CREATE TABLE TF_RISKPART_MASTER AS
SELECT MA.MASTER_REF 
FROM DIARYENTRY_ODS DE
INNER JOIN MASTER_ODS MA ON MA.KEY97=DE.MASTER_KEY
LEFT JOIN RELITEM_ODS RI ON RI.KEY97=DE.PERIOD_CHG AND RI.TYPEFLAG='20678'
LEFT JOIN BASEEVENT_ODS BE ON BE.KEY97=RI.EVENT_KEY 
LEFT JOIN PERIODCHG_ODS PC ON PC.KEY97=RI.KEY97
LEFT JOIN BASECHARGE_ODS BC ON BC.KEY97=RI.KEY97
LEFT JOIN EVENTCHG_ODS EC ON EC.KEY97=BC.KEY97
LEFT JOIN CHARGE99_ODS C99 ON C99.KEY97=EC.CHG_SCH
LEFT JOIN CHARGE04_ODS C04 ON C04.KEY97=C99.CHG_TYPE
WHERE DE.TYPEFLAG ='31115' 
AND MA.REFNO_PFIX = 'PTN'  AND TRIM(MA.EXPIRY_DAT) IS NOT NULL AND BC.CHG_DUE!=0 AND BC.STATUS!='W' 
union
SELECT MA.MASTER_REF FROM MASTER_ODS MA 
WHERE MA.REFNO_PFIX = 'PTN'  AND TRIM(MA.EXPIRY_DAT) IS NOT NULL AND MA.STATUS='LIV' AND MA.LIAB_AMT!=0;

commit;