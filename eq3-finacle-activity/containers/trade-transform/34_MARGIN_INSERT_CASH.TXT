TRUNCATE TABLE TF_MARGIN_MASTER;

INSERT INTO TF_MARGIN_MASTER
SELECT 
TRIM(REPLACE(M.MASTER_REF,'/','-')) B2KID,
'BNKGR' B2KID_TYPE,
'   1' MARGIN_SRL_NUM,
'Y' ENTITY_CRE_FLG,
'C' MARGIN_TYPE,
LC.MGN_CCY MARGIN_CRNCY,
LC.MGN_AMT/C.C8PWD COLLECT_AMT,
'0' RELEASE_AMT,
'700'||CRNCY_ALIAS_NUM||BG_MARGIN_CR_BACID MARGIN_ACID,--FIN_SOL_ID||CRNCY_ALIAS_NUM||BG_MARGIN_CR_BACID MARGIN_ACID,
T1.BG_OPERATIVE_ACCOUNT_ID OPER_ACID,
'' OPER_CRNCY,
'SYSTEM' LCHG_USER_ID,
SYSDATE LCHG_TIME,
'SYSTEM' RCRE_USER_ID,
SYSDATE RCRE_TIME,
'1' TS_CNT,
'001' DNM_SERIAL_NUM,
'01' BANK_ID
FROM LCMASTER_ODS LC
INNER JOIN MASTER_ODS M ON LC.KEY97=M.KEY97
INNER JOIN C8PF C ON LC.MGN_CCY=C.C8CCY
INNER JOIN TF001 T1 ON TRIM(T1.BG_NUM)=REPLACE(MASTER_REF,'/','-')
LEFT JOIN TBAADM.BGP BG ON BG.BG_TYPE=TRIM(T1.BG_TYPE) AND BG.BANK_ID='01'
LEFT JOIN TBAADM.CNC CN ON CN.CRNCY_CODE=LC.MGN_CCY AND CN.BANK_ID='01'
LEFT JOIN MAP_SOL SOL ON BR_CODE=CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(M.BHALF_BRN) ELSE TO_NUMBER(M.INPUT_BRN) END
WHERE M.KEY97=LC.KEY97 AND TO_NUMBER(LC.MGN_AMT)>0 AND TRIM(M.STATUS)='LIV' AND M.REFNO_PFIX = 'SBG' AND FUNC_cODE='A'
UNION ALL
SELECT 
TRIM(REPLACE(M.MASTER_REF,'/','-')) B2KID,
'DOCCR' B2KID_TYPE,
'   1' MARGIN_SRL_NUM,
'Y' ENTITY_CRE_FLG,
'C' MARGIN_TYPE,
LC.MGN_CCY MARGIN_CRNCY,
LC.MGN_AMT/C.C8PWD COLLECT_AMT,
'0' RELEASE_AMT,
'700'||CRNCY_ALIAS_NUM||DC_MARGIN_CR_BACID MARGIN_ACID,--FIN_SOL_ID||CRNCY_ALIAS_NUM||DC_MARGIN_CR_BACID MARGIN_ACID,
T4.DC_ACCOUNT_ID OPER_ACID,
'' OPER_CRNCY,
'SYSTEM' LCHG_USER_ID,
SYSDATE LCHG_TIME,
'SYSTEM' RCRE_USER_ID,
SYSDATE RCRE_TIME,
'1' TS_CNT,
'001' DNM_SERIAL_NUM,
'01' BANK_ID
FROM LCMASTER_ODS LC
INNER JOIN MASTER_ODS M ON LC.KEY97=M.KEY97
INNER JOIN C8PF C ON LC.MGN_CCY=C.C8CCY
INNER JOIN TF004 T4 ON TRIM(T4.DC_NUM)=REPLACE(MASTER_REF,'/','-') AND FUNC_CODE='S'
LEFT JOIN TBAADM.DCRM DC ON DC.REG_TYPE=TRIM(DC_TYPE) AND DC.BANK_ID='01'
LEFT JOIN TBAADM.CNC CN ON CN.CRNCY_CODE=LC.MGN_CCY AND CN.BANK_ID='01'
LEFT JOIN MAP_SOL SOL ON BR_CODE=CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(M.BHALF_BRN) ELSE TO_NUMBER(M.INPUT_BRN) END
WHERE M.KEY97=LC.KEY97 AND TO_NUMBER(LC.MGN_AMT)>0 AND TRIM(M.STATUS)='LIV' AND M.MASTER_REF LIKE 'ILC%'  AND M.REFNO_PFIX = 'ILC';


COMMIT;

