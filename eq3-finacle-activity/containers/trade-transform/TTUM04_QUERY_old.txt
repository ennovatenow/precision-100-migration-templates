DROP TABLE TF_TTUM04;

CREATE TABLE TF_TTUM04
(
  SOL_ID          CHAR(4 BYTE),
  ID              VARCHAR2(20 BYTE),
  CURRENCY        VARCHAR2(3 BYTE),
  AMOUNT          NUMBER,
  LEGACY_CODE     VARCHAR2(5 BYTE),
  CNC_ALIAS       VARCHAR2(3 CHAR),
  PRODUCT_CODE    CHAR(5 BYTE),
  ACCOUNT_TYPE    CHAR(2 BYTE),
  CONTRA_TYPE     CHAR(2 BYTE),
  BACID           CHAR(6 BYTE),
  CREDIT_BACID    VARCHAR2(16 CHAR),
  DEBIT_BACID     VARCHAR2(16 CHAR),
  KWD_EQUIVALENT  VARCHAR2(18 BYTE),
  EXCHANGE_RATE   NUMBER,
  EQUATION_MAP_AC VARCHAR2(13 CHAR)
);

commit;

truncate table TF_TTUM04;

commit;
--------------------BG RECORDS------------------
INSERT INTO TF_TTUM04
SELECT CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID, 
MA.MASTER_REF ID,TO_CHAR(MA.CCY) CURRENCY ,MA.LIAB_AMT/C8PWD AMOUNT,PR.CODE LEGACY_CODE,CNC.CRNCY_ALIAS_NUM CNC_ALIAS,
CASE WHEN PR.CODE='IN1' THEN 'LGBD'
     WHEN PR.CODE='IN2' THEN 'LGBD'
     WHEN PR.CODE='ADV' THEN 'LGAP'
     WHEN PR.CODE='PRF' THEN 'LGPR'
     WHEN PR.CODE='RTN' THEN 'LGRT'
     WHEN PR.CODE='CAS' THEN 'LGFN'
     WHEN PR.CODE='PUR' THEN 'LGPU'
     WHEN PR.CODE='MAI' THEN 'LGOT'
     WHEN PR.CODE='OTH' THEN 'LGOT'
     WHEN PR.CODE='TEL' THEN 'LGPH'
     WHEN PR.CODE='CAR' THEN 'LGVH'
     WHEN PR.CODE='LBR' THEN 'LGML'
     WHEN PR.CODE='SHP' THEN 'LGSH'
     WHEN PR.CODE='COL' THEN 'ILGC'
END PRODUCT_CODE,
CASE WHEN PR.CODE='IN1' THEN 'ST'
     WHEN PR.CODE='IN2' THEN 'SU'
     WHEN PR.CODE='ADV' THEN 'SQ'
     WHEN PR.CODE='PRF' THEN 'SR'
     WHEN PR.CODE='RTN' THEN 'SV'
     WHEN PR.CODE='CAS' THEN 'SW'
     WHEN PR.CODE='PUR' THEN 'SS'
     WHEN PR.CODE='COL' THEN 'SY'
     WHEN PR.CODE='MAI' THEN 'SO'
     WHEN PR.CODE='OTH' THEN 'SO'
     WHEN PR.CODE='TEL' THEN 'SO'
     WHEN PR.CODE='CAR' THEN 'SO'
     WHEN PR.CODE='LBR' THEN 'SG'
     WHEN PR.CODE='SHP' THEN 'RD'
END ACCOUNT_TYPE,
CASE WHEN PR.CODE='COL' THEN 'UY'
     WHEN PR.CODE='SHP' THEN 'TD'
     ELSE 'TE'
END CONTRA_TYPE,
'520000' BACID,
BG.BG_ISSUE_BACID CREDIT_BACID,
BG.CONST_LIAB_BACID DEBIT_BACID,
TO_CHAR((MA.LIAB_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS MA 
LEFT JOIN PRODTYPE_ODS PR ON MA.PRODTYPE=PR.KEY97
LEFT JOIN C8PF ON C8CCY=MA.CCY
LEFT JOIN IGMASTER_ODS IG ON IG.KEY97=MA.KEY97
LEFT JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
LEFT JOIN TBAADM.BGP BG ON BG.BG_TYPE=CASE WHEN PR.CODE='IN1' THEN 'LGBD'
     WHEN PR.CODE='IN2' THEN 'LGBD'
     WHEN PR.CODE='ADV' THEN 'LGAP'
     WHEN PR.CODE='PRF' THEN 'LGPR'
     WHEN PR.CODE='RTN' THEN 'LGRT'
     WHEN PR.CODE='CAS' THEN 'LGFN'
     WHEN PR.CODE='PUR' THEN 'LGPU'
     WHEN PR.CODE='MAI' THEN 'LGOT'
     WHEN PR.CODE='OTH' THEN 'LGOT'
     WHEN PR.CODE='TEL' THEN 'LGPH'
     WHEN PR.CODE='CAR' THEN 'LGVH'
     WHEN PR.CODE='LBR' THEN 'LGML'
     WHEN PR.CODE='SHP' THEN 'LGSH'
     WHEN PR.CODE='COL' THEN 'ILGC'
END  AND BG.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY AND SCAB=CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END 
                  AND SCACT IN (CASE WHEN PR.CODE='COL' THEN 'UY' WHEN PR.CODE='SHP' THEN 'TD' ELSE 'TE' END) AND SCBAL!=0
WHERE MA.LIAB_AMT!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX = 'SBG';
------------------END BG RECORDS---------------------
commit;
------------------ILC RECORDS ------------------------
insert into TF_TTUM04
SELECT CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID,
MASTER_REF,TO_CHAR(MA.CCY),MA.LIAB_AMT/C8PWD,PR.CODE,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(PR.CODE) IN ('SIG','USC') AND BENP.COUNTRY='KW' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='LCL' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY!='KWD' THEN 'SLCF'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY='KWD' THEN 'SLCL' ELSE 'ILCF' END DCTYPE,
--'ILCF' PRODUCT_TYPE,
CASE WHEN TRIM(PR.CODE)='SIG' THEN 'RA'
     WHEN TRIM(PR.CODE)='USC' THEN 'RB'
     WHEN TRIM(PR.CODE)='SBY' THEN 'XA'
     WHEN TRIM(PR.CODE)='LCL' THEN 'XB'
END ACCOUNT_TYPE,
--CASE WHEN PR.CODE='USC' THEN 'RB'
--     WHEN PR.CODE='SIG' THEN 'RA'
--     WHEN PR.CODE='SBY' THEN 'XA'
--     WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)='S' THEN 'XA'
--     WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)!='S' THEN 'XB'
--END ACCOUNT_TYPE,
CASE WHEN TRIM(PR.CODE) IN ('SIG','SBY') THEN 'TA'
     WHEN TRIM(PR.CODE) IN ('USC','LCL') THEN 'TB'
END CONTRA_TYPE,
--CASE WHEN TRIM(LC.TENOR_NO) IS NULL THEN 'TA' ELSE 'TB' END CONTRA_TYPE,
--CASE WHEN PR.CODE='USC' THEN 'TB'
--     WHEN PR.CODE IN ('SIG','SBY') THEN 'TA'
--     WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)='S' THEN 'TA'
--     WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)!='S' THEN 'TB'
--END CONTRA_TYPE,
'520000' BACID,
DR.DC_CONTRA_BACID,
DR.DC_CONST_BACID,
TO_CHAR((MA.LIAB_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS MA 
LEFT JOIN LCMASTER_ODS LC ON LC.KEY97=MA.KEY97
LEFT JOIN PARTYDTLS_ODS BENP ON BENP.KEY97=LC.BEN_PTY
LEFT JOIN PRODTYPE_ODS PR ON PR.KEY97=MA.PRODTYPE
LEFT JOIN C8PF ON C8CCY=MA.CCY
LEFT JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
LEFT JOIN TBAADM.DCRM DR ON DR.REG_TYPE= CASE WHEN TRIM(PR.CODE) IN ('SIG','USC') AND BENP.COUNTRY='KW' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='LCL' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY!='KWD' THEN 'SLCF'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY='KWD' THEN 'SLCL' ELSE 'ILCF' END 
     AND DR.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY AND SCAB=CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END AND 
               SCACT IN (CASE WHEN PR.CODE='USC' THEN 'TB'
                              WHEN PR.CODE IN ('SIG','SBY') THEN 'TA'
                              WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)='S' THEN 'TA'
                              WHEN PR.CODE='LCL' AND SUBSTR(TRIM(LC.TENOR_FROM),1,1)!='S' THEN 'TB'
                         END ) AND SCBAL!=0
WHERE MA.LIAB_AMT!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX IN 'ILC';
------------------END ILC RECORDS ---------------------------
commit;
------------------ELC RECORDS ------------------------
insert into TF_TTUM04
SELECT 
'900' SOL_ID, --CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END
MASTER_REF,TO_CHAR(MA.CCY),MA.LIAB_AMT/C8PWD,BENP.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(BENP.COUNTRY)='KW' THEN 'ELCL' ELSE 'ELCF' END PRODUCT_TYPE,
'RC' ACCOUNT_TYPE,
'TC' CONTRA_TYPE,
'520000' BACID,
DR.DC_CONTRA_BACID,
DR.DC_CONST_BACID,
TO_CHAR((MA.LIAB_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS MA 
LEFT JOIN LCMASTER_ODS LC ON LC.KEY97=MA.KEY97
LEFT JOIN PARTYDTLS_ODS BENP ON BENP.KEY97=LC.BEN_PTY
LEFT JOIN C8PF ON C8CCY=MA.CCY
LEFT JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
LEFT JOIN TBAADM.DCRM DR ON DR.REG_TYPE=CASE WHEN TRIM(BENP.COUNTRY)='KW' THEN 'ELCL' ELSE 'ELCF' END AND DR.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY AND  SCACT ='TC' AND SCBAL!=0 AND SCAB='0900'---SCAB=CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END AND
WHERE MA.LIAB_AMT!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX IN 'ELC';
------------------END ELC RECORDS ---------------------------
COMMIT;
----------------------OUTWARD BILLS COLLECTION -------------------
insert into TF_TTUM04
SELECT  
CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID,
MASTER_REF,TO_CHAR(MA.CCY),CD.O_S_AMT/C8PWD,PA.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'FOBCS' 
     WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'FOBCU'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'LOBCS'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'LOBCU'
END BILLPARAMTYPE,
'RK' ACCOUNT_TYPE,
'TK' CONTRA_TYPE,
'520000' BACID,
FB.CONTRA_LIAB_BACID,
FB.CONST_LIAB_BACID,
TO_CHAR((CD.O_S_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
--SELECT MA.MASTER_REF,CD.O_S_AMT,MA.AMT_O_S
FROM MASTER_ODS MA 
INNER JOIN C8PF ON C8CCY=MA.CCY
INNER JOIN COLLMASTER_ODS CM ON CM.KEY97=MA.KEY97
INNER JOIN PARTYDTLS_ODS PA ON PA.KEY97=CM.DRAWEE_PTY
INNER JOIN TIDATAITEM_ODS TI ON TI.MASTER_KEY=MA.KEY97 AND TI.TYPEFLAG IN ('336','7490','2051','9389')
INNER JOIN COLLDRAFT_ODS CD ON TI.KEY97=CD.KEY97
INNER JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
INNER JOIN TBAADM.FBPT FB ON FB.BILL_PARAM_TYPE=CASE WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'FOBCS' 
     WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'FOBCU'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'LOBCS'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'LOBCU'
END AND FB.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY AND SCAB=CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END AND SCACT ='TK' AND SCBAL!=0
WHERE CD.O_S_AMT!=0 AND MA.AMT_O_S!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX IN 'OUD';
----------------------END OUTWARD BILLS COLLECTION -------------------------------------
commit;
------------------------INWARD BILLS COLLECTION ------------------------------
insert into TF_TTUM04
SELECT TO_NUMBER(MA.INPUT_BRN) SOL_ID,
MASTER_REF,TO_CHAR(MA.CCY),CD.PAY_AMT/C8PWD,PA.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'FDBCS' 
     WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'FDBCU'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'LDBCS'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'LDBCU'
END BILLPARAMTYPE,
'RJ' ACCOUNT_TYPE,
'TJ' CONTRA_TYPE,
'520000' BACID,
FB.CONTRA_LIAB_BACID,
FB.CONST_LIAB_BACID,
TO_CHAR((CD.PAY_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
--SELECT MA.MASTER_REF,MA.AMT_O_S,CD.O_S_AMT
FROM MASTER_ODS MA 
INNER JOIN C8PF ON C8CCY=MA.CCY
INNER JOIN COLLMASTER_ODS CM ON CM.KEY97=MA.KEY97
INNER JOIN PARTYDTLS_ODS PA ON PA.KEY97=CM.DRAWER_PTY
INNER JOIN TIDATAITEM_ODS TI ON TI.MASTER_KEY=MA.KEY97 AND TI.TYPEFLAG IN ('336','7490','2051','9389')
INNER JOIN COLLDRAFT_ODS CD ON TI.KEY97=CD.KEY97
INNER JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
INNER JOIN TBAADM.FBPT FB ON FB.BILL_PARAM_TYPE=CASE WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'FDBCS' 
     WHEN TRIM(PA.COUNTRY)!='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'FDBCU'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)='S'  THEN 'LDBCS'
     WHEN TRIM(PA.COUNTRY)='KW' AND SUBSTR(CD.TENOR_FROM,1,1)!='S' THEN 'LDBCU'
END AND FB.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY  AND SCACT ='TJ' AND SCBAL!=0 AND SCAB=MA.INPUT_BRN--CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END
WHERE CD.O_S_AMT!=0 AND MA.TOTLIABAMT!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX IN 'COL' AND TRIM(CD.STATUS) NOT IN ('RT','P');
---------------------------END INWARD BILLS COLLECTION-------------------------------------
commit;
---------------------------ILC ACCEPTANCE BILLS---------------------------------------------
insert into TF_TTUM04
SELECT 
CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(M.BHALF_BRN) ELSE TO_NUMBER(M.INPUT_BRN) END SOL_ID,
M.MASTER_REF,TO_CHAR(M.CCY),B.AMOUNT/C8PWD,DRWR.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END BILLPARAMTYPE, 
'RH' ACCOUNT_TYPE,
'TH' CONTRA_TYPE,
'520000' BACID,
FB.ACCEPTANCE_CR_BACID,
FB.ACCEPTANCE_DR_BACID,
TO_CHAR((B.AMOUNT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS M
LEFT JOIN MAP_SOL SOL ON BR_NAME= M.INPUT_BRN
LEFT JOIN LCMASTER_ODS L ON M.KEY97=L.KEY97
LEFT JOIN BASEEVENT_ODS B ON B.MASTER_KEY=M.KEY97 AND B.AMOUNT!=0
LEFT JOIN PRODTYPE_ODS PR ON PR.KEY97=M.PRODTYPE
LEFT JOIN C8PF C8 ON C8.C8CCY=M.CCY
LEFT JOIN LCPAYMENT_ODS LCPAY ON LCPAY.KEY97=B.KEY97
LEFT JOIN PARTPAYMNT_ODS PARTPAY ON PARTPAY.OR_PAY_EV=B.KEY97 AND PARTPAY.PAYEV_KEY IS NULL
LEFT JOIN PARTYDTLS_ODS DRWR ON DRWR.KEY97=L.APP_PTY
INNER JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=M.CCY AND CNC.BANK_ID='01'
INNER JOIN TBAADM.FBPT FB ON FB.BILL_PARAM_TYPE=CASE WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END AND FB.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=M.CCY AND SCAB=CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN M.BHALF_BRN ELSE M.INPUT_BRN END AND SCACT ='TH' AND SCBAL!=0
WHERE  B.STATUS='c'  AND TRIM(B.REFNO_PFIX) = 'CLM'
AND M.REFNO_PFIX='ILC' --AND M.STATUS='LIV' 
AND TRIM(PARTPAY.PP_STAT) IN ('M','A');
-------------------------------END ILC BILLS ACCEPTANCE--------------------------------------
commit;
---------------------------ELC ACCEPTANCE BILLS---------------------------------------------
insert into TF_TTUM04
SELECT 
'900' SOL_ID,--CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(M.BHALF_BRN) ELSE TO_NUMBER(M.INPUT_BRN) END 
M.MASTER_REF,TO_CHAR(M.CCY),B.AMOUNT/C8PWD,DRWR.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(DRWR.COUNTRY)!='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END BILLPARAMTYPE, 
'RV' ACCOUNT_TYPE,
'TV' CONTRA_TYPE,
'520000' BACID,
FB.ACCEPTANCE_CR_BACID,
FB.ACCEPTANCE_DR_BACID,
TO_CHAR((B.AMOUNT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS M
LEFT JOIN MAP_SOL SOL ON BR_NAME= M.INPUT_BRN
LEFT JOIN LCMASTER_ODS L ON M.KEY97=L.KEY97
LEFT JOIN BASEEVENT_ODS B ON B.MASTER_KEY=M.KEY97 AND B.AMOUNT!=0
LEFT JOIN PRODTYPE_ODS PR ON PR.KEY97=M.PRODTYPE
LEFT JOIN C8PF C8 ON C8.C8CCY=M.CCY
LEFT JOIN LCPAYMENT_ODS LCPAY ON LCPAY.KEY97=B.KEY97
LEFT JOIN PARTPAYMNT_ODS PARTPAY ON PARTPAY.OR_PAY_EV=B.KEY97 AND PARTPAY.PAYEV_KEY IS NULL
LEFT JOIN PARTYDTLS_ODS DRWR ON DRWR.KEY97=L.APP_PTY
INNER JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=M.CCY AND CNC.BANK_ID='01'
LEFT JOIN TBAADM.FBPT FB ON FB.BILL_PARAM_TYPE=CASE WHEN TRIM(DRWR.COUNTRY)!='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' OR TRIM(DRWR.COUNTRY) IS NULL AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END AND FB.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=M.CCY AND SCACT ='TV' AND SCBAL!=0 AND SCAB='0900' --CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN M.BHALF_BRN ELSE M.INPUT_BRN END 
WHERE  B.STATUS='c'  AND TRIM(B.REFNO_PFIX) = 'DPR'
AND M.REFNO_PFIX='ELC' --AND M.STATUS='LIV'
AND M.LIAB_AMT!=0 
AND TRIM(PARTPAY.PP_STAT) IN ('M','A');
-------------------------------END ELC BILLS ACCEPTANCE--------------------------------------
commit;
---------------------------ILC DISCRIPTED BILLS---------------------------------------------
insert into TF_TTUM04
SELECT 
CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(M.BHALF_BRN) ELSE TO_NUMBER(M.INPUT_BRN) END SOL_ID,
M.MASTER_REF,TO_CHAR(M.CCY),B.AMOUNT/C8PWD,DRWR.COUNTRY,CNC.CRNCY_ALIAS_NUM,
CASE WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END BILLPARAMTYPE, 
'LQ' ACCOUNT_TYPE,
'' CONTRA_TYPE,
'520000' BACID,
'',
FB.DFLT_DELINK_BACID,
TO_CHAR((B.AMOUNT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS M
LEFT JOIN MAP_SOL SOL ON BR_NAME= M.INPUT_BRN
LEFT JOIN LCMASTER_ODS L ON M.KEY97=L.KEY97
LEFT JOIN BASEEVENT_ODS B ON B.MASTER_KEY=M.KEY97 AND B.AMOUNT!=0
LEFT JOIN PRODTYPE_ODS PR ON PR.KEY97=M.PRODTYPE
LEFT JOIN C8PF C8 ON C8.C8CCY=M.CCY
LEFT JOIN LCPAYMENT_ODS LCPAY ON LCPAY.KEY97=B.KEY97
LEFT JOIN PARTPAYMNT_ODS PARTPAY ON PARTPAY.OR_PAY_EV=B.KEY97 AND PARTPAY.PAYEV_KEY IS NULL
LEFT JOIN PARTYDTLS_ODS DRWR ON DRWR.KEY97=L.APP_PTY
LEFT JOIN GFPF_ODS GF ON TRIM(GF.GFCUS1)=TRIM(DRWR.CUS_MNM)
INNER JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=M.CCY AND CNC.BANK_ID='01'
INNER JOIN TBAADM.FBPT FB ON FB.BILL_PARAM_TYPE=CASE WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is null  THEN 'FIBLS' 
     WHEN TRIM(DRWR.COUNTRY)!='KW' AND trim(PERIOD_NO) is not null THEN 'FIBLU'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is null  THEN 'LIBLS'
     WHEN TRIM(DRWR.COUNTRY)='KW' AND trim(PERIOD_NO) is not null THEN 'LIBLU'
END AND FB.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=M.CCY AND SCACT ='LQ' AND SCBAL!=0 AND SCAB=GF.GFBRNM AND SCAN=GF.GFCPNC--SCAN||' '||SUBSTR(SCAB,2,3)=TRIM(DRWR.CUS_MNM)--SCAB=CASE WHEN TRIM(M.BHALF_BRN) IS NOT NULL THEN M.BHALF_BRN ELSE M.INPUT_BRN END 
WHERE  B.STATUS='c'  AND TRIM(B.REFNO_PFIX) = 'CLM' AND PARTPAY.PP_STAT NOT IN ('P','R','M','A') AND LCPAY.PMT_STATUS='R'
AND M.REFNO_PFIX='ILC' AND M.STATUS!='BKF';
-------------------------------END ILC BILLS ACCEPTANCE--------------------------------------
commit;

-----------------------BG MARGIN----------------------------
insert into TF_TTUM04
SELECT 
CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID,
MA.MASTER_REF, 
TO_CHAR(LC.MGN_CCY),
LC.MGN_AMT/C8PWD,
'',
CN.CRNCY_ALIAS_NUM,
'',
'DK',
'',
'520000',
BG_MARGIN_CR_BACID MARGIN_ACID,
'',
TO_CHAR((LC.MGN_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
''
FROM LCMASTER_ODS LC
INNER JOIN MASTER_ODS MA ON LC.KEY97=MA.KEY97
INNER JOIN C8PF C ON LC.MGN_CCY=C.C8CCY
LEFT JOIN PRODTYPE_ODS PR ON TRIM(PR.KEY97)=TRIM(MA.PRODTYPE)
LEFT JOIN TBAADM.BGP BG ON BG.BG_TYPE=CASE WHEN PR.CODE='IN1' THEN 'LGBD'
                                           WHEN PR.CODE='IN2' THEN 'LGBD'
                                           WHEN PR.CODE='ADV' THEN 'LGAP'
                                           WHEN PR.CODE='PRF' THEN 'LGPR'
                                           WHEN PR.CODE='RTN' THEN 'LGRT'
                                           WHEN PR.CODE='CAS' THEN 'LGFN'
                                           WHEN PR.CODE='PUR' THEN 'LGPU'
--          WHEN PR.CODE='COL' AND (TRIM(I.GTE_ID) IS NULL OR TRIM(I.GTE_ID)='R') THEN 'LGCL'
                                           WHEN PR.CODE='MAI' THEN 'LGOT'
                                           WHEN PR.CODE='OTH' THEN 'LGOT'
                                           WHEN PR.CODE='TEL' THEN 'LGPH'
                                           WHEN PR.CODE='CAR' THEN 'LGVH'
                                           WHEN PR.CODE='LBR' THEN 'LGML'
                                           WHEN PR.CODE='SHP' THEN 'LGSH'
     END AND BG.BANK_ID='01'
LEFT JOIN TBAADM.CNC CN ON CN.CRNCY_CODE=LC.MGN_CCY AND CN.BANK_ID='01'
WHERE MA.KEY97=LC.KEY97 AND TO_NUMBER(LC.MGN_AMT)>0 AND TRIM(MA.STATUS)='LIV' AND MA.REFNO_PFIX = 'SBG';
----------------------END BG MARGIN ----------------------------
commit;
----------------------LC MARGIN-----------------------------
insert into TF_TTUM04
SELECT 
CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID,
MA.MASTER_REF, 
TO_CHAR(LC.MGN_CCY),
LC.MGN_AMT/C8PWD,
'',
CN.CRNCY_ALIAS_NUM,
'',
'DJ',
'',
'520000',
DC_MARGIN_CR_BACID ACCOUNT,
'',
TO_CHAR((LC.MGN_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
''
FROM LCMASTER_ODS LC
INNER JOIN MASTER_ODS MA ON LC.KEY97=MA.KEY97
INNER JOIN C8PF C ON LC.MGN_CCY=C.C8CCY
LEFT JOIN PARTYDTLS_ODS BENP ON BENP.KEY97=LC.BEN_PTY
LEFT JOIN PRODTYPE_ODS PR ON PR.KEY97=MA.PRODTYPE
LEFT JOIN TBAADM.DCRM DC ON DC.REG_TYPE=CASE WHEN TRIM(PR.CODE) IN ('SIG','USC') AND BENP.COUNTRY='KW' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='LCL' THEN 'ILCL'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY!='KWD' THEN 'SLCF'
     WHEN TRIM(PR.CODE)='SBY' AND MA.CCY='KWD' THEN 'SLCL' ELSE 'ILCF' END AND DC.BANK_ID='01'
LEFT JOIN TBAADM.CNC CN ON CN.CRNCY_CODE=LC.MGN_CCY AND CN.BANK_ID='01'
WHERE MA.KEY97=LC.KEY97 AND TO_NUMBER(LC.MGN_AMT)>0 AND TRIM(MA.STATUS)='LIV' AND MA.MASTER_REF LIKE 'ILC%'  AND MA.REFNO_PFIX = 'ILC';
--------------------------END LC MARGIN-------------------------------------------
commit;
----------------------RISK PARTICIPATION-----------------------------
insert into TF_TTUM04
SELECT 
CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN TO_NUMBER(MA.BHALF_BRN) ELSE TO_NUMBER(MA.INPUT_BRN) END SOL_ID, 
MA.MASTER_REF ID,TO_CHAR(MA.CCY) CURRENCY ,MA.LIAB_AMT/C8PWD AMOUNT,PR.CODE LEGACY_CODE,CNC.CRNCY_ALIAS_NUM CNC_ALIAS,
CASE WHEN PR.CODE='BLG' THEN 'RPLG'
     WHEN PR.CODE='BLC' THEN 'RPLC'
END PRODUCT_CODE,
CASE WHEN PR.CODE='BLG' THEN 'SM'
     WHEN PR.CODE='BLC' THEN 'XG'
END ACCOUNT_TYPE,
CASE WHEN PR.CODE='BLG' THEN 'UM'
     WHEN PR.CODE='BLC' THEN 'UG'
END CONTRA_TYPE,
'520000' BACID,
BG.BG_ISSUE_BACID CREDIT_BACID,
BG.CONST_LIAB_BACID DEBIT_BACID,
TO_CHAR((MA.LIAB_AMT/C8PWD)*C8SPT,'99999999999999.99') KWD_EQUIVALENT,
C8SPT EXCH_RATE,
SCAB||SCAN||SCAS
FROM MASTER_ODS MA 
LEFT JOIN PRODTYPE_ODS PR ON MA.PRODTYPE=PR.KEY97
LEFT JOIN C8PF ON C8CCY=MA.CCY
--LEFT JOIN IGMASTER_ODS IG ON IG.KEY97=MA.KEY97
LEFT JOIN TBAADM.CNC CNC ON CNC.CRNCY_CODE=MA.CCY AND CNC.BANK_ID='01'
LEFT JOIN TBAADM.BGP BG ON BG.BG_TYPE=CASE WHEN PR.CODE='BLG' THEN 'RPLG' WHEN PR.CODE='BLC' THEN 'RPLC' END  AND BG.BANK_ID='01'
LEFT JOIN SCPF ON SCCCY=MA.CCY AND SCAB=CASE WHEN TRIM(MA.BHALF_BRN) IS NOT NULL THEN MA.BHALF_BRN ELSE MA.INPUT_BRN END 
                  AND SCACT IN (CASE WHEN PR.CODE='BLG' THEN 'UM' WHEN PR.CODE='BLC' THEN 'UG' END) AND SCBAL!=0
WHERE MA.LIAB_AMT!=0 AND MA.STATUS='LIV' AND MA.REFNO_PFIX = 'PTN';
--------------------------END RISK PARTICIPATION-------------------------------------------
COMMIT;


TRUNCATE TABLE TTUM_EXCEL_TRADE;

INSERT INTO TTUM_EXCEL_TRADE
SELECT trim(SOL_ID)||CNC_ALIAS||BACID||ACCOUNT_TYPE,CURRENCY,TRIM(SOL_ID),'C',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE not in ('DJ','DK','LQ','RK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||BACID||ACCOUNT_TYPE,TRIM(SOL_ID),CURRENCY,'C','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||BACID||CONTRA_TYPE,CURRENCY,TRIM(SOL_ID),'D',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE not in ('DJ','DK','LQ','RK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||BACID||CONTRA_TYPE,TRIM(SOL_ID),CURRENCY,'D','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,CURRENCY,TRIM(SOL_ID),'D',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE not in ('DJ','DK','LQ','RK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,TRIM(SOL_ID),CURRENCY,'D','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,CURRENCY,TRIM(SOL_ID),'C',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE not in ('DJ','DK','LQ','RK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,TRIM(SOL_ID),CURRENCY,'C','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||BACID||account_type,CURRENCY,TRIM(SOL_ID),'C',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 T4 where ACCOUNT_TYPE='LQ'
GROUP BY trim(SOL_ID)||CNC_ALIAS||BACID||account_type,TRIM(SOL_ID),CURRENCY,'C','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,CURRENCY,TRIM(SOL_ID),'D',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 T4 where ACCOUNT_TYPE='LQ'
GROUP BY trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,TRIM(SOL_ID),CURRENCY,'D','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||BACID||ACCOUNT_TYPE,CURRENCY,TRIM(SOL_ID),'D',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE in ('DJ','DK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||BACID||ACCOUNT_TYPE,TRIM(SOL_ID),CURRENCY,'D','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,CURRENCY,TRIM(SOL_ID),'C',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE in ('DJ','DK')
GROUP BY trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,TRIM(SOL_ID),CURRENCY,'C','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,CURRENCY,TRIM(SOL_ID),'D',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE='RK'
GROUP BY trim(SOL_ID)||CNC_ALIAS||DEBIT_BACID,TRIM(SOL_ID),CURRENCY,'D','TTUM04 BALANCE'
UNION
SELECT trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,CURRENCY,TRIM(SOL_ID),'C',SUM(AMOUNT),'TTUM04 BALANCE' FROM TF_TTUM04 where ACCOUNT_TYPE='RK'
GROUP BY trim(SOL_ID)||CNC_ALIAS||CREDIT_BACID,TRIM(SOL_ID),CURRENCY,'C','TTUM04 BALANCE';

commit;

truncate table ttum4_o_table;

insert into ttum4_o_table
select 
--Account Number
    rpad(ACCOUNT,16,' '),
--Currency Code     
    rpad(ccy,3,' '),
--SOLID
    rpad(SOL_ID,8,' '),
--Part Tran Type
    INDICATOR,
--Transaction Amount
    lpad(abs(AMOUNT),17,' '),
--Transaction Particular
    rpad(PERTICULARS,30,' '),
    rpad(' ',5,' '),
    rpad(' ',20,' '),
    rpad(' ',5,' '),
    rpad(' ',10,' '),
    rpad(' ',6,' '),
    rpad(' ',16,' '),
    rpad(' ',1,' '),
    lpad(abs(AMOUNT),17,' '),
    rpad(ccy,3,' '),
    rpad(' ',5,' '),
    rpad(' ',15,' '),
    rpad(get_param('EOD_DATE'),10,' '),
    rpad(' ',10,' '),
    rpad(' ',5,' '),
    rpad(' ',6,' '),
    rpad(' ',6,' '),
    rpad(' ',2,' '),
    rpad(' ',1,' '),
    rpad(' ',12,' '),
    rpad(' ',10,' '),
    rpad(' ',20,' '),
    rpad(' ',5,' '),
    rpad(' ',30,' '),
    rpad(' ',40,' '),
    rpad(' ',40,' '),
    rpad(' ',40,' '),
    rpad(' ',40,' '),
    rpad(' ',40,' '),
    rpad(' ',17,' '),
    rpad(' ',17,' '),
    rpad(' ',17,' '),
    rpad(' ',17,' '),
    rpad(' ',17,' '),
    rpad(' ',30,' '),
    rpad(' ',16,' '),
    rpad(' ',12,' '),
    rpad(' ',10,' '),
    rpad(' ',10,' '),
    rpad(' ',9,' '),
    rpad(' ',4,' '),
    rpad(' ',34,' '),
    rpad(' ',256,' '),
    rpad(' ',16,' '),
    rpad(' ',5,' '),
    rpad(' ',5,' ')
from ttum_excel_trade;

commit;

---select * from ttum4_o_table

--select sol_id,CURRENCY,account_type,sum(amount) from tf_ttum04 group by sol_id,CURRENCY,account_type 
--
--select scab,scccy,scact,sum(scbal/c8pwd) from scpf
--left join c8pf on c8ccy=scccy
--where scbal!=0 and scact in ('DJ','DK','RA','RB','RC','RE','RH','RJ','RK','SA','SB','SD','SE','SF','SG','SY','XA')
--group by scab,scccy,scact 

