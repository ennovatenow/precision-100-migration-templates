TRUNCATE TABLE TF_MARGIN_MASTER_FD;

INSERT INTO TF_MARGIN_MASTER_FD
SELECT DISTINCT 
REPLACE(MA.MASTER_REF,'/','-') B2KID,
'BNKGR' B2KID_TYPE,'   1' MARGIN_SRL_NUM,
'Y' ENTITY_CRE_FLG,
'L' MARGIN_TYPE,
CO.CCY MARGIN_CRNCY,
CO.AMOUNT/C8PWD COLLECT_AMT,
0 RELEASE_AMT,'' MARGIN_ACID,TRIM(LT.ACCOUNT_NUMBER) OPER_ACID,'' OPER_CRNCY,
'SYSTEM' LCHG_USER_ID,SYSDATE LCHG_TIME,'SYSTEM' RCRE_USER_ID,SYSDATE RCRE_TIME,'1' TS_CNT,'001' DNM_SERIAL_NUM,'01' BANK_ID
--MA.CCY,MA.LIAB_AMT/C8M.C8PWD LIAB_AMT,TRIM(REPLACE(REPLACE(CO.CUST_DDA,'-',''),' ','')) CUST_DDA,CO.DESCRPTION,MP.FIN_ACC_NUM,TRIM(LT.ACCOUNT_NUMBER),LT.LIEN_AMOUNT,CO.AMOUNT/C8PWD
FROM TIDATAITEM_ODS TI
INNER JOIN MASTER_ODS MA ON MA.KEY97=TI.MASTER_KEY
LEFT JOIN COLLATERAL_ODS CO ON CO.KEY97=TI.KEY97
INNER JOIN C8PF C8M ON C8M.C8CCY=CO.CCY
LEFT JOIN MAP_ACC MP ON MP.EXTERNAL_ACC=TRIM(REPLACE(REPLACE(CO.CUST_DDA,'-',''),' ',''))
LEFT JOIN LIEN_O_TABLE LT ON TRIM(LT.ACCOUNT_NUMBER)=TRIM(MP.FIN_ACC_NUM)
WHERE TI.MASTER_KEY IN (SELECT KEY97 FROM MASTER_ODS WHERE REFNO_PFIX ='SBG' AND STATUS='LIV' AND LIAB_AMT!=0) 
AND TI.TYPEFLAG='523' AND TRIM(LT.ACCOUNT_NUMBER) IS NOT NULL AND TRIM(MA.USEROPTN2) IS NOT NULL
UNION
SELECT DISTINCT 
REPLACE(MA.MASTER_REF,'/','-') B2KID,'DOCCR' B2KID_TYPE,'   1' MARGIN_SRL_NUM,'Y' ENTITY_CRE_FLG,'L' MARGIN_TYPE,
CO.CCY MARGIN_CRNCY,CO.AMOUNT/C8PWD COLLECT_AMT,0 RELEASE_AMT,'' MARGIN_ACID,TRIM(LT.ACCOUNT_NUMBER) OPER_ACID,'' OPER_CRNCY,
'SYSTEM' LCHG_USER_ID,SYSDATE LCHG_TIME,'SYSTEM' RCRE_USER_ID,SYSDATE RCRE_TIME,'1' TS_CNT,'001' DNM_SERIAL_NUM,'01' BANK_ID
--MA.CCY,MA.LIAB_AMT/C8M.C8PWD LIAB_AMT,TRIM(REPLACE(REPLACE(CO.CUST_DDA,'-',''),' ','')) CUST_DDA,CO.DESCRPTION,MP.FIN_ACC_NUM,TRIM(LT.ACCOUNT_NUMBER),LT.LIEN_AMOUNT,CO.AMOUNT/C8PWD
FROM TIDATAITEM_ODS TI
INNER JOIN MASTER_ODS MA ON MA.KEY97=TI.MASTER_KEY
LEFT JOIN COLLATERAL_ODS CO ON CO.KEY97=TI.KEY97
INNER JOIN C8PF C8M ON C8M.C8CCY=CO.CCY
LEFT JOIN MAP_ACC MP ON MP.EXTERNAL_ACC=TRIM(REPLACE(REPLACE(CO.CUST_DDA,'-',''),' ',''))
LEFT JOIN LIEN_O_TABLE LT ON TRIM(LT.ACCOUNT_NUMBER)=TRIM(MP.FIN_ACC_NUM)
WHERE TI.MASTER_KEY IN (SELECT KEY97 FROM MASTER_ODS WHERE REFNO_PFIX ='ILC' AND STATUS='LIV' AND LIAB_AMT!=0) 
AND TI.TYPEFLAG='523' AND TRIM(LT.ACCOUNT_NUMBER) IS NOT NULL;


COMMIT;


--SELECT B2KID,COUNT(1) FROM TF_MARGIN_MASTER_FD GROUP BY B2KID HAVING COUNT(1)>1

--EDIT TF_MARGIN_MASTER_FD WHERE B2KID='615-111386-16'

--SELECT * FROM LIEN_O_TABLE WHERE TRIM(ACCOUNT_NUMBER) IN ('0615696300010','0615696300100')

--select * from tf_margin_master where b2kid in (select b2kid from tf_margin_master_fd where MARGIN_SRL_NUM='   1')

--edit tf_margin_master_fd where b2kid='616-053923-05'